<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Elevance AI</title>
    <link rel="stylesheet" href="static/css/style.css">
    {% if gtm_container_id %}
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','{{ gtm_container_id }}');</script>
    <!-- End Google Tag Manager -->
    {% endif %}
</head>
<body class="home-page">
    {% if gtm_container_id %}
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ gtm_container_id }}"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    {% endif %}
    
    <nav class="navbar navbar-minimal">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="/" class="nav-brand-link">
                    <h2>Elevance AI</h2>
                </a>
            </div>
            <div class="nav-menu">
                <a href="/dashboard" class="nav-link">Dashboard</a>
            </div>
        </div>
    </nav>

    <section class="pricing-section" style="padding-top: 4rem;">
        <div class="container-narrow">
            <div style="text-align: center; max-width: 600px; margin: 0 auto;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">âœ…</div>
                <h1 style="font-size: 2rem; font-weight: 300; margin-bottom: 1rem; letter-spacing: -1px;">Payment Successful!</h1>
                <p style="color: var(--text-secondary); font-size: 1.125rem; margin-bottom: 2rem;">
                    Thank you for your payment. Your photos are now ready to download.
                </p>
                {% if payment %}
                <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 2rem; text-align: left;">
                    <p style="margin-bottom: 0.5rem;"><strong>Payment Details:</strong></p>
                    <p style="margin-bottom: 0.25rem; color: var(--text-secondary);">Photos: {{ payment.photo_count }}</p>
                    <p style="margin-bottom: 0.25rem; color: var(--text-secondary);">Amount: ${{ "%.2f"|format(payment.amount / 100) }}</p>
                    <p style="margin-bottom: 0; color: var(--text-secondary);">Status: <span style="color: #10b981;">{{ payment.status|title }}</span></p>
                </div>
                {% endif %}
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <a href="/dashboard" class="btn btn-primary btn-large" id="dashboardBtn">Go to Dashboard</a>
                    <a href="/" class="btn btn-outline btn-large">Enhance More Photos</a>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Auto-download photos after successful payment
        (function() {
            const photosData = {{ photos_data|safe }};
            const photoIds = {{ photo_ids|safe }};
            
            if (photosData && photosData.length > 0) {
                // Convert photos to proper format
                const photoList = photosData.map(function(photo) {
                    var filename = photo.enhanced_filename.replace('enhanced_', '').replace('.jpg', '');
                    return {
                        id: photo.id,
                        enhancedUrl: '/api/photos/' + photo.id + '/enhanced',
                        originalName: filename
                    };
                });
                
                console.log('Starting auto-download for', photoList.length, 'photos');
                
                // Download function
                function downloadImage(url, filename) {
                    fetch(url)
                        .then(function(response) {
                            return response.blob();
                        })
                        .then(function(blob) {
                            const blobUrl = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = blobUrl;
                            link.download = filename.endsWith('.jpg') ? filename : filename + '.jpg';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(blobUrl);
                        })
                        .catch(function(error) {
                            console.error('Error downloading image:', error);
                            // Fallback: open in new tab
                            window.open(url, '_blank');
                        });
                }
                
                // Track download promises to ensure they complete
                let downloadPromises = [];
                
                // Download all photos with slight delay between each
                let downloadIndex = 0;
                function downloadNext() {
                    if (downloadIndex < photoList.length) {
                        const photo = photoList[downloadIndex];
                        const filename = photo.originalName.endsWith('.jpg') 
                            ? photo.originalName 
                            : photo.originalName + '.jpg';
                        
                        // Create a promise for this download
                        const downloadPromise = new Promise(function(resolve, reject) {
                            fetch(photo.enhancedUrl)
                                .then(function(response) {
                                    return response.blob();
                                })
                                .then(function(blob) {
                                    const blobUrl = window.URL.createObjectURL(blob);
                                    const link = document.createElement('a');
                                    link.href = blobUrl;
                                    link.download = filename;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    window.URL.revokeObjectURL(blobUrl);
                                    console.log('Downloaded:', filename);
                                    resolve();
                                })
                                .catch(function(error) {
                                    console.error('Error downloading image:', error);
                                    // Fallback: open in new tab
                                    window.open(photo.enhancedUrl, '_blank');
                                    resolve(); // Continue even if one fails
                                });
                        });
                        
                        downloadPromises.push(downloadPromise);
                        downloadIndex++;
                        
                        // Wait a bit before next download to avoid browser blocking
                        setTimeout(downloadNext, 500);
                    } else {
                        // All downloads initiated, wait for them to complete
                        console.log('All downloads initiated, waiting for completion...');
                        Promise.all(downloadPromises).then(function() {
                            console.log('All downloads complete, redirecting to dashboard...');
                            // Redirect to dashboard after all downloads complete
                            setTimeout(function() {
                                window.location.href = '/dashboard';
                            }, 1000);
                        }).catch(function(error) {
                            console.error('Some downloads failed:', error);
                            // Still redirect even if some failed
                            setTimeout(function() {
                                window.location.href = '/dashboard';
                            }, 2000);
                        });
                    }
                }
                
                // Start downloading after a brief delay to let page render
                setTimeout(function() {
                    downloadNext();
                }, 1500);
            } else {
                // No photos to download, just redirect to dashboard after a short delay
                setTimeout(function() {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        })();
    </script>

    <footer class="home-footer">
        <div class="container-narrow">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Elevance AI</h3>
                    <p>AI-powered photo enhancement for real estate professionals.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Elevance AI. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>


